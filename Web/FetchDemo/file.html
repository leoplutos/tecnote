<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="icon"
		href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”¥</text></svg>" />
	<title>æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹</title>
	<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">
	<style>
		:root {
			--pico-font-size: 100%;
		}

		.drag-input {
			display: none;
		}

		#dropzone {
			width: 100%;
			height: 100%;
			text-align: center;
			line-height: 300px;
			color: #aaaaaa;
			background-color: #fffbf0;
			outline: 2px dashed #92b0b3;
			outline-offset: -1px;
			/*border: 4px dashed #92b0b3;*/
		}

		/* å½“æœ‰æ–‡ä»¶æ‚¬åœåœ¨æ”¾ç½®åŒºåŸŸä¸Šæ–¹æ—¶çš„æ ·å¼ */
		#dropzone.dragover {
			background-color: #d8eaef;
			outline-color: #92b0f3;
			outline-offset: -15px;
		}

		.drag-label {
			color: #aaaaaa;
			/*display: inline-block;*/
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}

		.drag-label div {
			line-height: 20px;
		}
	</style>
</head>

<body>
	<main class="container">
		<section id="section1">
			<h2>æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹</h2>
			<div>æœ€å¤šä¸Šä¼ 10ä¸ªæ–‡ä»¶, åç«¯æ˜¯ ASP.NET Core é»˜è®¤ä¸Šä¼ æœ€å¤§ä¸º 28.6 MB</div>
			<div>æ›´å¤šçœ‹<a
					href="https://learn.microsoft.com/zh-cn/aspnet/core/mvc/models/file-uploads?view=aspnetcore-8.0">è¿™é‡Œ</a>
			</div>
			<br />
			<div id="dropzone">
				<!--å› ä¸ºåç«¯ä½¿ç”¨çš„ASP.NET Core, æ‰€ä»¥nameå±æ€§è¦å’Œåç«¯ä¸€è‡´-->
				<input type="file" id="fileInput" name="uploadFiles" class="drag-input" multiple>
				<label for="fileInput" id="fileList" class="drag-label">ç‚¹å‡»ä¸Šä¼ æˆ–å°†æ–‡ä»¶æ‹–è‡³æ­¤å¤„ï¼ˆå…¨æ ¼å¼ï¼‰</label>
			</div>
			<br />
			<progress id="uploadProgress" value="0" max="100"></progress>
			<br />
			<button id="uploadBtn">ä¸Šä¼ æ–‡ä»¶</button>
			<button id="reUploadBtn">é‡æ–°ä¸Šä¼ </button>
		</section>
	</main>
	<script>
		// è¦è¿›è¡Œä¸Šä¼ çš„æ–‡ä»¶
		var allFiles = [];

		// è·å–ç›¸å…³å…ƒç´ 
		const dropzone = document.getElementById('dropzone');
		const fileInput = document.getElementById('fileInput');
		const fileList = document.getElementById('fileList');
		const uploadBtn = document.getElementById('uploadBtn');
		const reUploadBtn = document.getElementById('reUploadBtn');
		const uploadProgress = document.getElementById('uploadProgress');

		// å¤„ç†æ–‡ä»¶æ‹–æ‹½è¿›å…¥æ”¾ç½®åŒºåŸŸçš„äº‹ä»¶
		dropzone.addEventListener('dragover', function (e) {
			// é˜»æ­¢äº‹ä»¶å†’æ³¡
			e.stopPropagation();
			// é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼ˆä¸dropäº‹ä»¶ç»“åˆï¼Œé˜»æ­¢æ‹–æ‹½æ–‡ä»¶åœ¨æµè§ˆå™¨æ‰“å¼€çš„é»˜è®¤è¡Œä¸ºï¼‰
			e.preventDefault();
			dropzone.classList.add('dragover');
		});

		// å¤„ç†æ–‡ä»¶æ‹–æ‹½ç¦»å¼€æ”¾ç½®åŒºåŸŸçš„äº‹ä»¶
		dropzone.addEventListener('dragleave', function (e) {
			// é˜»æ­¢äº‹ä»¶å†’æ³¡
			e.stopPropagation();
			// é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼ˆä¸dropäº‹ä»¶ç»“åˆï¼Œé˜»æ­¢æ‹–æ‹½æ–‡ä»¶åœ¨æµè§ˆå™¨æ‰“å¼€çš„é»˜è®¤è¡Œä¸ºï¼‰
			e.preventDefault();
			dropzone.classList.remove('dragover');
		});

		// å¤„ç†æ–‡ä»¶åœ¨æ”¾ç½®åŒºåŸŸå†…é‡Šæ”¾çš„äº‹ä»¶
		dropzone.addEventListener('drop', function (e) {
			// é˜»æ­¢äº‹ä»¶å†’æ³¡
			e.stopPropagation();
			// é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼ˆä¸dropäº‹ä»¶ç»“åˆï¼Œé˜»æ­¢æ‹–æ‹½æ–‡ä»¶åœ¨æµè§ˆå™¨æ‰“å¼€çš„é»˜è®¤è¡Œä¸ºï¼‰
			e.preventDefault();
			dropzone.classList.remove('dragover');

			// æ‹–æ‹½é€‰æ‹©çš„æ–‡ä»¶
			const files = e.dataTransfer.files;
			// æ·»åŠ æ‰€é€‰æ–‡ä»¶
			addFile(files);
			// æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
			displayFileInfo();
		});

		// å¤„ç†æ–‡ä»¶è¾“å…¥æ¡†å€¼æ”¹å˜çš„äº‹ä»¶ï¼Œå½“é€šè¿‡ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æ—¶ä¹Ÿèƒ½æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
		fileInput.addEventListener('change', function (event) {
			// è¾“å…¥æ¡†é€‰æ‹©çš„æ–‡ä»¶
			const files = event.target.files;
			// æ·»åŠ æ‰€é€‰æ–‡ä»¶
			addFile(files);
			// æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
			displayFileInfo();
		});

		// æ·»åŠ æ‰€é€‰æ–‡ä»¶
		function addFile(files) {
			if ((allFiles.length + files.length) > 10) {
				alert("æ— æ³•ä¸Šä¼ è¶…è¿‡10ä¸ªæ–‡ä»¶");
				return;
			}
			for (let i = 0; i < files.length; i++) {
				// å‘åˆ—è¡¨ä¸­æ·»åŠ å…ƒç´ 
				allFiles.push(files[i]);
			}
		}

		// æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
		function displayFileInfo() {
			fileList.innerHTML = '';
			allFiles.forEach(function (element, index, array) {
				// console.log(`ç´¢å¼• ${index} çš„å…ƒç´ æ˜¯ï¼š${element}`);
				const listItem = document.createElement('div');
				listItem.textContent = `æ–‡ä»¶åï¼š${element.name}ï¼Œå¤§å°ï¼š${element.size} å­—èŠ‚`;
				fileList.appendChild(listItem);
			});
		}

		// æ–‡ä»¶ä¸Šä¼ 
		// è¿™é‡Œè°ƒç”¨ ASP.NET Core çš„åç«¯
		uploadBtn.addEventListener('click', function () {
			uploadProgress.value = 0;
			if (allFiles.length === 0) {
				alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶");
				return;
			}
			const confirmReuslt = confirm("ç¡®å®šä¸Šä¼ ï¼Ÿ");
			if (!confirmReuslt) {
				return;
			}
			// å°†æ–‡ä»¶ä¿¡æ¯æ”¾åˆ°FormDataä¸­ï¼Œç„¶åè¿›è¡Œä¼ è¾“
			let formData = new FormData();
			for (let i = 0; i < allFiles.length; i++) {
				const file = allFiles[i];
				// å› ä¸ºåç«¯ä½¿ç”¨çš„ASP.NET Core, ç¬¬ä¸€ä¸ªå‚æ•°uploadFilesè¦å’Œåç«¯ä¸€è‡´
				formData.append("uploadFiles", file, file.name);
				// console.log(formData.getAll("uploadFiles"));
			}
			// ä½¿ç”¨ajaxå‘é€è¯·æ±‚
			// éœ€è¦åç«¯å¼€å¯å…è®¸è·¨åŸŸ
			const xhr = new XMLHttpRequest();
			const backendUrl = "http://localhost:9501/upload";
			// ç›‘å¬ä¸Šä¼ è¿›åº¦progressäº‹ä»¶ï¼Œéœ€è¦åœ¨openä¹‹å‰
			xhr.upload.addEventListener("progress", function (event) {
				if (event.lengthComputable) {
					// event.loaded è¡¨ç¤ºå·²ç»ä¸Šä¼ çš„è¿›åº¦
					// event.total è¡¨ç¤ºæ€»è¿›åº¦
					const percentComplete = Math.round((event.loaded / event.total) * 100);
					uploadProgress.value = percentComplete;
				}
			});
			xhr.upload.addEventListener("loadend", function (event) {
				console.log("ä¼ è¾“å®Œæˆ,å°½ç®¡æˆ‘ä»¬ä¸çŸ¥é“å®ƒæ˜¯å¦æˆåŠŸ");
			});
			// ç›‘å¬ä¸‹è½½è¿›åº¦ï¼Œéœ€è¦åœ¨openä¹‹å‰
			xhr.addEventListener("progress", function (event) {
			});
			// xhr.setRequestHeader("Content-Type", "multipart/form-data");
			xhr.open('POST', backendUrl, true);
			xhr.onreadystatechange = function () {
				// åˆ¤æ–­ajaxçŠ¶æ€
				if (xhr.readyState === XMLHttpRequest.DONE) {
					// åˆ¤æ–­httpé€šä¿¡ç 
					if (xhr.status === 200) {
						// å“åº”çš„ç»“æœæ˜¯JSONå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è§£ææˆåŸæ¥çš„æ ·å­
						//const resultJson = JSON.parse(xhr.response);
						const resultJson = JSON.parse(xhr.responseText);
						// åˆ¤æ–­ä¸šåŠ¡çŠ¶æ€ç 
						if (resultJson.code !== 200) {
							console.log(`ä¸Šä¼ å¤±è´¥, responseText:${xhr.responseText}`);
						} else {
							allFiles = [];
							fileList.innerHTML = 'ç‚¹å‡»ä¸Šä¼ æˆ–å°†æ–‡ä»¶æ‹–è‡³æ­¤å¤„ï¼ˆå…¨æ ¼å¼ï¼‰';
							console.log("ä¸Šä¼ æˆåŠŸ");
						}
					} else {
						console.log(`ä¸Šä¼ å¤±è´¥, responseText:${xhr.responseText}, status:${xhr.status}`);
					}
				}
			};
			xhr.send(formData);
		});

		// é‡æ–°ä¸Šä¼ 
		reUploadBtn.addEventListener('click', function () {
			allFiles = [];
			fileList.innerHTML = 'ç‚¹å‡»ä¸Šä¼ æˆ–å°†æ–‡ä»¶æ‹–è‡³æ­¤å¤„ï¼ˆå…¨æ ¼å¼ï¼‰';
			uploadProgress.value = 0;
		});
	</script>
</body>

</html>
