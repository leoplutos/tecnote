# 微服务

## 简介

### 单体架构

早期的软件，所有功能都写在一起，这称为 ``单体架构``（monolithic software），软件的功能越多，单体架构就会越复杂，很多缺点也随之暴露出来
1. 所有功能耦合在一起，互相影响，最终难以管理。
2. 哪怕只修改一行代码，整个软件就要重新构建和部署，成本非常高。
3. 因为软件做成了一个整体，不可能每个功能单独开发和测试，只能整体开发和测试，导致必须采用瀑布式开发模型

### 微服务架构

``微服务架构`` 就是把一个大型的单体程序，拆分成一个个独立服务，也就是较小的程序。每个服务都是一个独立的功能单元，承担不同的功能，服务之间通过通信协议连在一起，随着 Docker 的出现，彻底改变了软件开发的面貌。它让程序运行在容器中，每个容器可以分别设定运行环境，并且只占用很少的系统资源

这种架构有很多优点

1. 每种服务功能单一，相当于一个小型软件，便于开发和测试。
2. 各个服务独立运行，简化了架构，提高了可靠性。
3. 鼓励和支持代码重用，同一个服务可以用于多种目的。
4. 不同服务可以单独开发和部署，便于升级。
5. 扩展性好，可以容易地加机器、加功能，承受高负载。
6. 不容易出现单点故障。即使一个服务失败了，不会影响到其他服务。


## 微服务应该思考的内容

下面记录了笔者的学习路径，并不一定是最优解

#### 服务间通信
- [gRPC/Protobuf](../Go/Grpc_zh_CN.md)
- Thrift
- Spring Cloud
- HTTP/ msgpack
- go-zero

#### 服务注册、服务发现
- [基于K8S的服务发现](./Kubernetes_zh_CN.md)
- [基于etcd自定制](./Etcd_zh_CN.md.md)

#### 服务监控

- 日志收集(Log)
    - Docker(containerd) + [Fluent Bit](./Fluent_Bit_zh_CN.md) + Loki + Grafana
    - [OpenTelemetry](./OpenTelemetry_zh_CN.md)

- 链路追踪(Tracing)
    - [OpenTelemetry](./OpenTelemetry_zh_CN.md)  
        - Trace : 调用的链路过程，trace id 是指这次请求调用的 ID
        - Span : 一个模块的调用过程，一般用 span id 来标识  
            通过 ``trace id`` + ``span id`` 就可以定位到问题发生在哪里，并且可以判断出 ``上级 span id`` 和 ``下级 span id`` 分别是谁

- 指标/度量 监控(Metrics)
    - [OpenTelemetry](./OpenTelemetry_zh_CN.md)  
        - 度量类监控主要采用 ``时序数据库`` 的解决方案
        - 以事件发生时间以及当前数值的角度来记录的监控信息
        - 这类监控主要不是用来查问题的，主要是用来看趋势的

#### 容器编排与自动扩容
- [K8S](./Kubernetes_zh_CN.md)

#### 分布式事务
- [DTM](./DTM_zh_CN.md)
- Seata

#### 容错隔离

当某个微服务出现故障，最大限度的隔离单个服务的风险，也就是 ``容错隔离`` 的方法。不仅保证了微服务架构的正常运行，也保证了系统的可用性和健壮性

[Sentinel](https://github.com/alibaba/Sentinel)，[Spring Cloud Circuit Breaker](https://spring.io/projects/spring-cloud-circuitbreaker/)， [resilience4j](https://github.com/resilience4j/resilience4j) 都是不错的实现

- 超时  
    这是简单的容错方式。指在服务之间调用时，设置一个主动超时时间作为时间阈值

- 限流  
    顾名思义，就是限制最大流量。系统能提供的最大并发有限，同时来的请求又太多，服务无法处理请求，就只好排队限流。常见的限流算法有：``计算器限流``、``漏桶算法``、``令牌漏桶算法``、``集群限流算法``

- 服务降级  
    与限流类似，一样是流量太多，系统服务不过来。这个时候可将不是那么重要的功能模块进行降级处理，停止服务，这样可以释放出更多的资源供给核心功能的去用（例如淘宝双十一活动会对订单查询服务降级来保证购买下单服务的可用性）

- 熔断
    可以理解成就像电闸的保险丝一样，当流量过大或者错误率过大的时候，保险丝就熔断了，链路就断开了，不提供服务了  
    当流量恢复正常，或者后端服务稳定了，保险丝会自动街上（熔断闭合），服务又可以正常提供了。这是一种很好的保护后端微服务的一种方式  
    熔断技术中有个很重要的概念就是：``断路器``

## 其他

### 服务级别协议 (SLA)
服务级别协议 (Service Level Agreement) 是服务提供商与客户之间的合同，其中定义了要提供的服务和预期的性能水平。SLA 还描述了如何衡量和批准性能，以及未达到性能水平时会发生什么

### 服务级别目标 (SLO)
服务级别目标 (SLO) 是 SLA 的一部分，它为服务的特定方面（例如错误率、请求延迟或正常运行时间）设定性能基准。性能指标和 KPI 用于评估所提供服务的质量，并确定服务提供商是否满足 SLA 条款的要求。

监控适当的指标是 SLA 成功的重要组成部分。如果没有正确的数据，就很难知道该安排为各方服务的水平如何。跟踪过多的指标会造成混乱，导致难以识读。不同的服务需要跟踪不同的指标，但常见的 SLA 指标包括：

#### 可用性和运行时间
正常运行时间是服务正常运行并可供使用的时间。该指标通常以一段时间内的百分比形式给出，例如每 30 天运行时间为 99.5%（停机时间为 3.6 小时）。正常运行时间要求将因业务类型而异，SLA 将反映这一点。

例如，对于在全球开展业务的电子商务平台来说，每月 3.6 小时的停机时间可能太多了。此类公司可能需要保证更多的可用性，并会寻求能够反映这一可用性要求的 SLA。

#### 错误率
错误率是一种衡量标准，用于跟踪生产或服务故障，以及 IT 服务提供商的服务级别低于预期绩效目标的时间百分比。该协议可能包括针对错过最后期限、功能或更新发布延迟、帮助台负面交互、编码错误率、缺陷率和其他技术质量衡量标准等问题的 SLO。

#### 响应时间
响应时间规定了提供商记录和响应客户问题或请求的可接受时间。

#### 解决时间
解决时间用于确定提供商记录问题后解决问题的可接受时间。

#### 平均恢复时间
该指标是在发生故障或中断后恢复产品、服务或系统所需的平均时间。

#### 首次呼叫解决率
该指标用于衡量在首次与服务台或聊天机器人交互时问题得到提供商解决的客户百分比。

#### 放弃率
对于客户服务提供商或拥有客户服务组件的组织来说，这是一个关键指标。放弃率是指客户在收到帮助台答复之前放弃客户支持咨询的比率。

#### 安全性
可以衡量各种安全措施，例如未公开的漏洞、防病毒更新或软件补丁，以评估提供商对 IT 安全的承诺。

#### 业务成果
通过使用适当的指标和 KPI，组织可以确定提供商的服务或产品如何为实现更广泛的业务目标做出贡献。例如，正在进行数字化转型的公司可能会问：提供商的云资源工具是否可以帮助我们重新控制云计算支出？跟踪正确的数据将有助于回答这个问题。
