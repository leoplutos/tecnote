# é…ç½® Gitea Actions çš„å·¥ä½œæµ

# å·¥ä½œæµåç§°
name: "Deploy Action"
run-name: Gitea Actions ğŸš€ For deploy
# åœ¨mainåˆ†æ”¯è¢«pushæ—¶è§¦å‘
on:
  push:
    branches:
      - main

# ä»»åŠ¡å®šä¹‰
jobs:
  Deploy-Actions:
    # å®šä¹‰åœ¨å“ªç§ç±»å‹çš„è¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    # https://gitea.com/gitea/runner-images
    runs-on: ubuntu-latest
    # è‡ªå®šä¹‰ç¯å¢ƒå˜é‡
    env:
      JAVA_TOOL_OPTIONS: -Duser.language=en -Dfile.encoding=UTF-8 -Dlog4j2.asyncQueueFullPolicy=Discard -Dlog4j2.discardThreshold=ERROR
      #GITHUB_URL: https://github.com/
      GITHUB_URL: https://bgithub.xyz/
    steps:
      - name: ä»»åŠ¡è¯´æ˜
        run: |
          echo "ğŸ‰ æ­¤ä»»åŠ¡æºè‡ª ${{ gitea.event_name }} äº‹ä»¶çš„è‡ªåŠ¨è§¦å‘"
          echo "ğŸ§ æ­¤ä»»åŠ¡åœ¨ Gitea æ‰˜ç®¡çš„ ${{ runner.os }} æœåŠ¡å™¨ä¸Šè¿è¡Œ"
          echo "ğŸ” åˆ†æ”¯æ˜¯ ${{ gitea.ref }}, ä»“åº“æ˜¯ ${{ gitea.repository }}"

      - name: å…‹éš†ä»“åº“ä»£ç 
        # https://gitea.com/actions/checkout
        uses: https://gitea.com/actions/checkout@v4

      - name: ç¼“å­˜æœ¬åœ°Mavenä»“åº“
        # https://gitea.com/actions/cache
        uses: https://gitea.com/actions/cache@v4
        with:
          path: |
            ~/.m2
            /root/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            ${{ runner.os }}-

      - name: è‡ªå®šä¹‰ temurin OpenJDK 21 ä¸‹è½½
        run: |
          download_url="${{ env.GITHUB_URL }}adoptium/temurin21-binaries/releases/download/jdk-21.0.3%2B9/OpenJDK21U-jdk_x64_linux_hotspot_21.0.3_9.tar.gz"
          wget -O $RUNNER_TEMP/java_package.tar.gz $download_url

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ temurin OpenJDK 21
        # https://gitea.com/actions/setup-java
        uses: https://gitea.com/actions/setup-java@v4
        with:
          #distribution: "temurin"
          distribution: 'jdkfile'
          jdkFile: ${{ runner.temp }}/java_package.tar.gz
          java-version: "21"
          cache: 'maven'
          mvn-toolchain-vendor: Eclipse Temurin

      - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ Maven
        # https://github.com/stCarolas/setup-maven
        uses: ${{ env.GITHUB_URL }}stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.7

      - name: è®¾å®šMavené˜¿é‡Œäº‘é•œåƒ
        # https://github.com/s4u/maven-settings-action
        uses: ${{ env.GITHUB_URL }}s4u/maven-settings-action@v3.0.0
        with:
          mirrors: '[{"id": "alimaven", "name": "aliyun maven", "mirrorOf": "central", "url": "http://maven.aliyun.com/nexus/content/groups/public/"}]'

      - name: Mavenç¼–è¯‘
        run: |
          export JAVA_TOOL_OPTIONS="${{ env.JAVA_TOOL_OPTIONS }}"
          mvn clean package -Dmaven.test.skip=true

      - name: SSHéƒ¨ç½²
        # https://github.com/cross-the-world/ssh-scp-ssh-pipelines
        # è¿™ä¸ªæ­¥éª¤å¤±è´¥äº†ï¼Œéœ€è¦ç»§ç»­è°ƒæŸ¥
        uses: ${{ env.GITHUB_URL }}cross-the-world/ssh-scp-ssh-pipelines@latest
        env:
          WELCOME: "ssh scp ssh pipelines"
          LASTSSH: "Doing something after copying"
        with:
          # secrets ä¸ºåœ¨ gitea é¡µé¢è®¾ç½®çš„å¯†åŒ™ï¼Œå…³é”®ä¿¡æ¯éšè—
          #host: ${{ secrets.TARGET_HOST }}
          #port: ${{ secrets.TARGET_PORT }}
          #user: ${{ secrets.TARGET_USER }}
          #pass: ${{ secrets.TARGET_PASSWORD }}
          host: 172.18.0.1
          port: 8122
          user: lch
          pass: 123456
          connect_timeout: 10s
          first_ssh: |
            echo ====å¼€å§‹éƒ¨ç½²=======
            # åœæ­¢å½“å‰å®¹å™¨
            docker stop spring_8082
            # åˆ é™¤å½“å‰å®¹å™¨
            docker rm spring_8082
            # åˆ é™¤å½“å‰é•œåƒ
            docker rmi spring_boot_undertow:latest
            # åˆ¶ä½œæ–°çš„é•œåƒ
            rm /home/lch/workspace/SpringBootUndertow/target/SpringBootUndertow-1.0.0.jar
          scp: |
            './target/*.jar' => /home/lch/workspace/drone_deploy/target/
          last_ssh: |
            cp -afp /home/lch/workspace/drone_deploy/target/SpringBootUndertow-1.0.0.jar /home/lch/workspace/SpringBootUndertow/target/SpringBootUndertow-1.0.0.jar
            cd /home/lch/workspace/SpringBootUndertow/shell
            bash docker_build.sh
            # å¯åŠ¨æ–°çš„å®¹å™¨
            docker run -itd -p 8082:8090 --name spring_8082 spring_boot_undertow:latest
            echo ====éƒ¨ç½²æˆåŠŸ=======

      - name: ä»»åŠ¡ç»“æœ
        run: |
          echo "ğŸ’¡ ä»“åº“ ${{ gitea.repository }} å·²å…‹éš†åˆ°è¿è¡Œå™¨"
          echo "ä»“åº“ä¸­çš„æ–‡ä»¶"
          ls -l ${{ gitea.workspace }}
          ls -l ${{ gitea.workspace }}/target
          echo "ğŸ ä»»åŠ¡ç»“æœç  ${{ job.status }}"
